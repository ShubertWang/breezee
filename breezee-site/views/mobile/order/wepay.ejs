<!DOCTYPE html>
<html>
<head>
    <% include ../common/meta.ejs %>
    <title>订单支付</title>
    <% include ../common/public.ejs %>
    <style>
        .weui_cell:before {
            left: 0;
        }
    </style>
</head>
<body ontouchstart>
<form id="form1" runat="server">
    <div style="text-align: center; margin-top: 50px;">
        当前网络环境： <span class="int"></span>
        <br/>
        <br/>
        <br/>
        <span id="payMsg" style="color: Red;">微信支付测试：0.01 元</span>
        <br/>
        <span id="Span1" style="color: Red;">订单编号：<%= body.code %></span>
        <br/>
        <%= body.timestamp %>
        <br/>
        <%= body.nonceStr %>
        <br/>
        <%= body.package %>
        <br/>
        <%= body.signType %>
        <br/>
        <%= body.paySign %>
    </div>
    <div style="margin-top: 200px; text-align: right;">
        <span style="font-size: 12px; color: #CCC;">测试微信支付 </span>
    </div>
</form>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script type="text/javascript">
    wx.config({
        debug: true,
        appId: '<%= body.appId %>', // 必填，公众号的唯一标识
        timestamp: "<%= body.timestamp %>",
        nonceStr: "<%= body.nonceStr %>",
        signature: "<%= body.signature %>",
        jsApiList: [  // 必填，需要使用的JS接口列表
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'getNetworkType',
            'chooseWXPay'
        ]
    });
    wx.ready(function () {
//        document.querySelector('#payOK').onclick = function () {
//            wx.chooseWXPay({
//                timestamp: "<%= body.timestamp %>", // 支付签名时间戳
//                nonceStr: "<%= body.nonceStr %>", // 支付签名随机串
//                package: "<%= body.package %>", // 统一支付接口返回的package包
//                signType: "<%= body.signType %>", // 签名方式，'MD5'
//                paySign: "<%= body.paySign %>", // 支付签名
//                success: function (res) {
//                    if (res.err_msg == "get_brand_wcpay_request:ok") {
//                        alert("支付成功");
//                        // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
//                    }
//                }
//            });
//        };

        wx.chooseWXPay({
            timestamp: "<%= body.timestamp %>", // 支付签名时间戳
            nonceStr: "<%= body.nonceStr %>", // 支付签名随机串
            package: "<%= body.package %>", // 统一支付接口返回的package包
            signType: "<%= body.signType %>", // 签名方式，'MD5'
            paySign: "<%= body.paySign %>", // 支付签名
            success: function (res) {
                if (res.err_msg == "get_brand_wcpay_request:ok") {
                    alert("支付成功");
                    // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                }
            }
        });

        var shareData = {
            title: '微信支付测试',
            desc: '都被这傻X玩意整哭了-.-',
            link: 'http://***/wxpay/pay.aspx',
            imgUrl: 'http://***/wxshare.jpg',
            trigger: function (res) {
                //alert('用户点击发送给朋友');
            },
            success: function (res) {
                //alert('已分享');
            },
            cancel: function (res) {
                //alert('已取消');
            },
            fail: function (res) {
                //alert(JSON.stringify(res));
            }
        };

        //监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
        wx.onMenuShareAppMessage(shareData);
        //监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
        wx.onMenuShareTimeline(shareData);
        //获取用户网络状态
        wx.getNetworkType({
            success: function (res) {
                $(".int").html(res.networkType);
                document.getElementById("int").innerHTML = res.networkType;
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
        //监听错误事件 出现'invalid signature' AJAX刷新ticket,并刷新当前页面
        wx.error(function (res) {
            if (res.errMsg.indexOf("invalid signature") > 0) {
                alert("无效的签名，需要更新");
            }
            else {
                alert(res.errMsg);
            }
        });

    });
</script>

<% include ../common/footer.ejs %>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
<script>
</script>
</body>
</html>
